# بوابة المستفيدين - النافذة المنبثقة

## نظرة عامة

تم تحويل بوابة المستفيدين إلى نافذة منبثقة متكاملة تفتح مباشرة من الصفحة الرئيسية، مما يوفر تجربة مستخدم سلسة وسريعة بدون الحاجة للتنقل بين صفحات متعددة.

## الميزات الرئيسية

### 1. الوصول السريع
- زر "تسجيل الدخول إلى حسابي" يظهر مباشرة في نتائج البحث
- النافذة المنبثقة تفتح فوق الصفحة الرئيسية
- خلفية معتمة مع تأثير blur للتركيز
- إمكانية الإغلاق والعودة في أي وقت

### 2. المصادقة بكلمة المرور BIN

#### تسجيل الدخول (للمستخدمين الحاليين)
- إدخال رقم الهوية (9 أرقام) في الصفحة الرئيسية
- البحث عن المستفيد
- فتح النافذة المنبثقة
- إدخال كلمة المرور (6 أرقام)
- الدخول للوحة التحكم الشخصية

#### إنشاء حساب جديد (الزيارة الأولى)
- البحث عن رقم الهوية
- فتح النافذة المنبثقة
- النظام يكتشف أن المستفيد لم يسجل بعد
- إنشاء كلمة مرور جديدة (6 أرقام)
- تأكيد كلمة المرور
- الدخول مباشرة للوحة التحكم

### 3. لوحة التحكم الشخصية

تحتوي على 4 أقسام رئيسية:

#### أ. الملف الشخصي
- عرض جميع البيانات الشخصية
- تعديل رقم الهاتف والعنوان
- حفظ التغييرات
- مشاركة الموقع الجغرافي الحالي

#### ب. المستندات
- عرض صورة الهوية الحالية
- رفع صورة هوية جديدة
- معاينة الصورة قبل الحفظ
- إرشادات واضحة للمتطلبات
- حد أقصى للحجم: 5 ميجابايت

#### ج. الطرود
- عرض جميع الطرود المخصصة للمستفيد
- حالة كل طرد (تم التسليم، قيد التوصيل، قادم)
- تاريخ التسليم المتوقع
- القيمة والممول
- رقم التتبع

#### د. الأمان
- حالة التوثيق (موثق، قيد المراجعة، مرفوض)
- معلومات كلمة المرور
- آخر دخول للبوابة
- نصائح الأمان
- إمكانية تغيير كلمة المرور

### 4. حالة التوثيق

يظهر مؤشر بصري واضح لحالة التوثيق في عدة أماكن:
- **موثق** (أخضر): الحساب موثق وجاهز
- **قيد المراجعة** (أصفر): تحت المراجعة من الإدارة
- **مرفوض** (أحمر): تم رفض التوثيق، يحتاج لتعديل

### 5. سجل النشاطات

جميع التحديثات يتم تسجيلها تلقائياً:
- تحديث رقم الهاتف
- تحديث العنوان
- رفع صورة الهوية
- مشاركة الموقع
- تسجيل الدخول والخروج

## التصميم والواجهة

### التصميم العام
- نافذة منبثقة بعرض متوسط (مريحة للقراءة)
- تصميم متجاوب يعمل على الجوال وسطح المكتب
- ألوان متسقة مع النظام
- أيقونات واضحة من Lucide React

### الرأس (Header)
- خلفية زرقاء متدرجة
- اسم المستفيد ورقم الهوية
- شارة حالة التوثيق
- صورة رمزية (الحرف الأول من الاسم)

### التبويبات
- 4 تبويبات واضحة في الرأس
- تحول سلس بين الأقسام
- أيقونة لكل قسم
- عداد للطرود

### المحتوى
- مساحة كافية للقراءة
- حقول نماذج واضحة
- أزرار واضحة الغرض
- رسائل تأكيد وأخطاء مرئية

## الأمان

### سياسات Row Level Security (RLS)
- المستفيدون يمكنهم قراءة بياناتهم فقط
- المستفيدون يمكنهم تحديث بياناتهم الأساسية
- جميع التحديثات مسجلة في activity_log
- حماية من محاولات الدخول المتكررة

### حماية كلمة المرور
- كلمة مرور من 6 أرقام
- تشفير بسيط للحماية
- قفل الحساب بعد 5 محاولات فاشلة
- قفل لمدة 30 دقيقة بعد المحاولات الفاشلة

### سجل النشاطات
- تسجيل تلقائي لجميع العمليات
- تتبع من قام بالتحديث ومتى
- مصدر العملية (beneficiary, admin, system)
- تفاصيل التغييرات

## التكامل مع قاعدة البيانات

### الجداول المستخدمة
- `beneficiaries`: البيانات الشخصية
- `beneficiary_auth`: المصادقة وكلمات المرور
- `packages`: الطرود المخصصة
- `activity_log`: سجل النشاطات
- `system_features`: ميزات النظام

### الحقول الجديدة
- `beneficiaries.profile_photo_url`: صورة الملف الشخصي
- `beneficiaries.last_portal_access`: آخر دخول للبوابة

### المشغلات (Triggers)
- `trigger_log_beneficiary_update`: تسجيل تلقائي للتحديثات

## استخدام المكونات

### في LandingPage.tsx
```tsx
import BeneficiaryPortalModal from './BeneficiaryPortalModal';

// في الحالة
const [showPortalModal, setShowPortalModal] = useState(false);
const [fullBeneficiary, setFullBeneficiary] = useState<Beneficiary | null>(null);

// في JSX
<BeneficiaryPortalModal
  isOpen={showPortalModal}
  onClose={() => setShowPortalModal(false)}
  nationalId={nationalId}
  initialBeneficiary={fullBeneficiary}
/>
```

### خصائص المكون (Props)
- `isOpen`: حالة ظهور النافذة
- `onClose`: دالة الإغلاق
- `nationalId`: رقم الهوية للبحث
- `initialBeneficiary`: بيانات المستفيد الأولية

## سير العمل

### للمستفيد الجديد
1. يدخل رقم الهوية في الصفحة الرئيسية
2. يضغط على "بحث"
3. تظهر معلوماته الأساسية وطروده
4. يضغط على "تسجيل الدخول إلى حسابي"
5. تفتح النافذة المنبثقة
6. النظام يطلب منه إنشاء كلمة مرور جديدة
7. يدخل كلمة مرور ويؤكدها
8. يدخل مباشرة إلى لوحة التحكم
9. يمكنه تحديث بياناته ورفع صورة الهوية

### للمستفيد الحالي
1. يدخل رقم الهوية في الصفحة الرئيسية
2. يضغط على "بحث"
3. تظهر معلوماته الأساسية وطروده
4. يضغط على "تسجيل الدخول إلى حسابي"
5. تفتح النافذة المنبثقة
6. يدخل كلمة المرور (6 أرقام)
7. يدخل إلى لوحة التحكم
8. يمكنه تصفح طروده وتحديث معلوماته

## الفوائد

### للمستفيدين
- وصول أسرع وأسهل
- تجربة سلسة بدون تحويلات
- واجهة واضحة ومنظمة
- التحكم الكامل في البيانات
- تتبع الطرود بسهولة

### للإدارة
- تقليل الدعم الفني
- تحديثات تلقائية للبيانات
- سجل كامل للنشاطات
- تحقق أفضل من الهوية
- إحصائيات دقيقة

### التقنية
- كود منظم ومعياري
- سهولة الصيانة
- أداء أفضل (لا حاجة لتحميل صفحة جديدة)
- تجربة مستخدم حديثة
- متوافق مع الأجهزة المختلفة

## الملاحظات المهمة

1. **الأمان**: جميع العمليات محمية بـ RLS
2. **الأداء**: البيانات تحمل حسب الحاجة
3. **التوافق**: يعمل على جميع المتصفحات الحديثة
4. **الوصول**: يدعم لوحة المفاتيح (Enter للبحث والدخول)
5. **الصور**: حد أقصى 5 ميجابايت، يدعم JPG و PNG

## التطوير المستقبلي

يمكن إضافة المزيد من الميزات:
- التحقق بخطوتين (OTP)
- إشعارات فورية
- تاريخ الطرود السابقة
- تقييم الخدمة
- الدردشة مع الدعم
- مشاركة الموقع التلقائية
- إشعارات الطرود القادمة
